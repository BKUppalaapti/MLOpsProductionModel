name: MLOps Pipeline (DVC + Dagshub)

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  run-pipeline:
    runs-on: ubuntu-latest

    steps:

    # ------------------------------------
    # 1. CHECKOUT REPO
    # ------------------------------------
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0   # required so git push works

    # ------------------------------------
    # 2. BUILD DOCKER IMAGE
    # ------------------------------------
    - name: Build Docker image
      run: docker build -t mlops-clean .

    # ------------------------------------
    # 3. RUN DVC PIPELINE IN DOCKER
    # ------------------------------------
    - name: Run DVC pipeline inside Docker
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}

        DAGSHUB_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
        DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        DAGSHUB_REPO_OWNER: ${{ secrets.DAGSHUB_REPO_OWNER }}
        DAGSHUB_REPO_NAME: ${{ secrets.DAGSHUB_REPO_NAME }}

      run: |
        docker run --rm \
          -e AWS_ACCESS_KEY_ID="$AWS_ACCESS_KEY_ID" \
          -e AWS_SECRET_ACCESS_KEY="$AWS_SECRET_ACCESS_KEY" \
          -e AWS_DEFAULT_REGION="$AWS_DEFAULT_REGION" \
          -e DAGSHUB_USERNAME="$DAGSHUB_USERNAME" \
          -e DAGSHUB_TOKEN="$DAGSHUB_TOKEN" \
          -e DAGSHUB_REPO_OWNER="$DAGSHUB_REPO_OWNER" \
          -e DAGSHUB_REPO_NAME="$DAGSHUB_REPO_NAME" \
          -v "${{ github.workspace }}:/app" \
          -v "${{ github.workspace }}/.dvc/cache:/app/.dvc/cache" \
          mlops-clean

    # ------------------------------------
    # 4. COMMIT DVC CHANGES BACK TO GITHUB
    # ------------------------------------
    - name: Configure Git
      run: |
        git config --global user.email "actions@github.com"
        git config --global user.name "GitHub Actions"

    - name: Authenticate Git for pushing
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git

    - name: Pull latest changes to avoid conflicts
      run: git pull origin main --rebase || true

    - name: Commit DVC updates
      run: |
        git add dvc.lock || true
        git commit -m "Auto: Update DVC pipeline outputs [CI]" || echo "No changes to commit"

    - name: Push changes back to GitHub
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git push origin main || echo "Nothing to push"