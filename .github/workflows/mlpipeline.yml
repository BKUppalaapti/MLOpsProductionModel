name: MLOps Pipeline (DVC + Dagshub)

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  run-pipeline:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Build Docker image
      run: docker build -t mlops-clean .

    - name: Run DVC pipeline inside Docker
      env:
        # AWS / DVC remote
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}

        # Dagshub / MLflow
        DAGSHUB_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
        DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        DAGSHUB_REPO_OWNER: ${{ secrets.DAGSHUB_REPO_OWNER }}
        DAGSHUB_REPO_NAME: ${{ secrets.DAGSHUB_REPO_NAME }}

      run: |
        docker run --rm \
          -e AWS_ACCESS_KEY_ID \
          -e AWS_SECRET_ACCESS_KEY \
          -e AWS_DEFAULT_REGION \
          -e DAGSHUB_USERNAME \
          -e DAGSHUB_TOKEN \
          -e DAGSHUB_REPO_OWNER \
          -e DAGSHUB_REPO_NAME \
          mlops-clean
